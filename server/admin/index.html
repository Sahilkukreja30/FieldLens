<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Photo Verify | Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    @import url('https://rsms.me/inter/inter.css');

    .modal {
      display: none;
    }

    .modal.is-open {
      display: flex;
    }
  </style>
</head>

<body class="bg-gray-900 text-white">
  <div class="container mx-auto p-4 md:p-8">
    <header class="mb-8 flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-cyan-400">Admin Dashboard</h1>
        <p class="text-gray-400">Create and monitor photo verification jobs.</p>
      </div>
      <button id="createJobBtn"
        class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
        + Create New Job
      </button>
    </header>

    <main id="jobsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Job cards will be inserted here -->
    </main>
  </div>

  <!-- Modal for Creating a New Job -->
  <div id="jobModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4">
    <div class="bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-md">
      <h2 class="text-2xl font-bold mb-4 text-cyan-400">Create a New Job</h2>
      <form id="createJobForm">
        <div class="mb-4">
          <label for="workerPhone" class="block text-gray-400 text-sm font-bold mb-2">
            Worker's WhatsApp Number:
          </label>
          <input type="text" id="workerPhone" name="workerPhone"
            class="shadow-inner appearance-none border border-gray-700 rounded-lg w-full py-2 px-3 bg-gray-900 text-white leading-tight focus:outline-none focus:ring-2 focus:ring-cyan-500"
            placeholder="e.g., whatsapp:+919876543210" required />
          <p class="text-xs text-gray-500 mt-1">
            Must be in the format <code>whatsapp:+[country code][number]</code>.
          </p>
        </div>

        <!-- after the workerPhone field -->
        <div class="mb-4">
          <label for="sector" class="block text-gray-400 text-sm font-bold mb-2">
            Sector number (e.g., 1, 2, 3):
          </label>
          <input id="sector" name="sector" type="number" min="1" step="1"
            class="shadow-inner appearance-none border border-gray-700 rounded-lg w-full py-2 px-3 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500"
            placeholder="e.g., 3" required />
        </div>


        <div class="mb-6">
          <label class="block text-gray-400 text-sm font-bold mb-2">Required Photo Types (14):</label>
          <!-- Visual list of the 14-step sequence (no checkboxes) -->
          <div id="allTypesPreview" class="mt-1 text-xs text-gray-300 flex flex-wrap gap-2"></div>
        </div>

        <div class="flex items-center justify-end">
          <button type="button" id="cancelBtn"
            class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mr-2">
            Cancel
          </button>
          <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">
            Create Job
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Template for Job Card -->
  <template id="jobCardTemplate">
    <div class="bg-gray-800 rounded-lg shadow-lg p-5 flex flex-col justify-between">
      <div>
        <div class="flex justify-between items-start mb-3">
          <span class="job-id font-mono text-xs bg-gray-700 text-cyan-400 px-2 py-1 rounded"></span>
          <span class="job-status font-bold text-sm px-3 py-1 rounded-full"></span>
        </div>

        <p class="text-gray-400 text-sm mb-1">Worker:</p>
        <p class="job-worker-phone font-semibold text-lg text-white mb-4"></p>

        <p class="text-gray-400 text-sm mb-2">Required Photos:</p>
        <div class="job-required-types flex flex-wrap gap-2 mb-4"></div>

        <hr class="border-gray-700 my-4" />

        <h4 class="font-bold mb-3 text-gray-300">Submitted Photos</h4>
        <div class="job-photos grid grid-cols-2 gap-3 max-h-40 overflow-y-auto">
          <!-- Photos will be added here -->
        </div>
      </div>

      <button
        class="refresh-job-btn mt-4 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
        Refresh
      </button>

      <button
        class="export-csv-btn mt-2 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
        Export CSV
      </button>
      <button
        class="export-xlsx-btn mt-2 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
        Export XLSX
      </button>

      <button
        class="export-xlsx-img-btn mt-2 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
      Export XLSX (with photos)
    </button>

    </div>
  </template>

  <script>
    // ---- Config ----
    const API_BASE_URL = `${location.origin}/api`;
    const HOST_BASE = location.origin;

    // Authoritative 14-step sequence
    const REQUIRED_14 = [
      "INSTALLATION", "CLUTTER", "AZIMUTH", "A6_GROUNDING", "CPRI_GROUNDING",
      "POWER_TERM_A6", "CPRI_TERM_A6", "TILT", "LABELLING", "ROXTEC", "A6_PANEL",
      "MCB_POWER", "CPRI_TERM_SWITCH_CSS", "GROUNDING_OGB_TOWER"
    ];

    // ---- DOM refs ----
    const jobsContainer = document.getElementById('jobsContainer');
    const jobCardTemplate = document.getElementById('jobCardTemplate');
    const jobModal = document.getElementById('jobModal');
    const createJobBtn = document.getElementById('createJobBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const createJobForm = document.getElementById('createJobForm');
    const allTypesPreview = document.getElementById('allTypesPreview');

    // Render the visual 14-type list in the modal (pill style)
    allTypesPreview.innerHTML = REQUIRED_14
      .map(t => `<span class="inline-block bg-gray-700 text-gray-200 px-2.5 py-0.5 rounded">${t}</span>`)
      .join('');

    // ---- Helpers ----
    const getStatusClass = (status) => {
      switch (status) {
        case 'PENDING': return 'bg-yellow-900 text-yellow-300';
        case 'IN_PROGRESS': return 'bg-blue-900 text-blue-300';
        case 'DONE': return 'bg-green-900 text-green-300';
        default: return 'bg-gray-700 text-gray-300';
      }
    };

    const createJobCard = (job) => {
      const card = jobCardTemplate.content.cloneNode(true).children[0];
      card.dataset.jobId = job.id;

      card.querySelector('.job-id').textContent = `Job ID: ${job.id}`;

      const statusEl = card.querySelector('.job-status');
      statusEl.textContent = job.status;
      statusEl.className = `job-status font-bold text-sm px-3 py-1 rounded-full ${getStatusClass(job.status)}`;

      card.querySelector('.job-worker-phone').textContent = job.workerPhone;

      const requiredTypesContainer = card.querySelector('.job-required-types');
      requiredTypesContainer.innerHTML = '';
      (job.requiredTypes || []).forEach(type => {
        const typeEl = document.createElement('span');
        typeEl.className = 'bg-gray-700 text-gray-300 text-xs font-medium px-2.5 py-0.5 rounded';
        typeEl.textContent = type;
        requiredTypesContainer.appendChild(typeEl);
      });

      card.querySelector('.refresh-job-btn')
        .addEventListener('click', () => fetchJobDetails(job.id));

      card.querySelector('.export-csv-btn')
        .addEventListener('click', () => {
          window.open(`${API_BASE_URL}/jobs/${job.id}/export.csv`, '_blank');
        });

      card.querySelector('.export-xlsx-btn')
        .addEventListener('click', () => {
          window.open(`${API_BASE_URL}/jobs/${job.id}/export.xlsx`, '_blank');
        });

      card.querySelector('.export-xlsx-img-btn')
        .addEventListener('click', () => {
          window.open(`${API_BASE_URL}/jobs/${job.id}/export_with_images.xlsx`, '_blank');
        });


      return card;
    };

    const updateJobPhotos = (card, photos) => {
      const photosContainer = card.querySelector('.job-photos');
      photosContainer.innerHTML = '<p class="text-gray-500 text-sm col-span-2">No photos submitted yet.</p>';

      if (Array.isArray(photos) && photos.length > 0) {
        photosContainer.innerHTML = '';
        photos.forEach(photo => {
          const wrap = document.createElement('div');
          wrap.className = 'flex flex-col items-center p-2 rounded-lg';

          const img = document.createElement('img');
          img.alt = `Photo for job ${photo.jobId}`;
          img.className = 'w-16 h-16 object-cover rounded-md mb-2 border-2';
          img.onerror = () => { img.src = 'https://placehold.co/100x100/334155/e2e8f0?text=Error'; };

          img.src = (photo.s3Url && photo.s3Url.startsWith('/uploads'))
            ? `${HOST_BASE}${photo.s3Url}`
            : (photo.s3Url || 'https://placehold.co/100x100/334155/e2e8f0?text=No+Image');

          const ok = photo.status === 'PASS';
          img.className += ok ? ' border-green-500' : ' border-red-500';

          const meta = document.createElement('span');
          meta.textContent = `${photo.type}: ${photo.status}`;
          meta.className = `text-xs font-semibold ${ok ? 'text-green-400' : 'text-red-400'}`;

          wrap.appendChild(img);
          wrap.appendChild(meta);
          photosContainer.appendChild(wrap);
        });
      }
    };

    // ---- API ----
    const fetchAllJobs = async () => {
      try {
        const response = await fetch(`${API_BASE_URL}/jobs`);
        if (!response.ok) throw new Error('Failed to fetch jobs');
        const jobs = await response.json();

        jobsContainer.innerHTML = '';
        for (const job of jobs) {
          const card = createJobCard(job);
          jobsContainer.appendChild(card);
          fetchJobDetails(job.id, card);
        }
      } catch (err) {
        console.error('Error fetching jobs:', err);
        jobsContainer.innerHTML =
          `<p class="text-red-500 col-span-full">Error loading jobs. Is the backend server running?</p>`;
      }
    };

    const fetchJobDetails = async (jobId, cardElement) => {
      try {
        const card = cardElement || jobsContainer.querySelector(`[data-job-id='${jobId}']`);
        if (!card) return;

        const response = await fetch(`${API_BASE_URL}/jobs/${jobId}`);
        if (!response.ok) throw new Error(`Failed to fetch details for job ${jobId}`);
        const data = await response.json();
        // Expected shape: { job: {...}, photos: [...] }

        const jobData = data.job || data; // tolerate either shape
        const statusEl = card.querySelector('.job-status');
        statusEl.textContent = jobData.status;
        statusEl.className = `job-status font-bold text-sm px-3 py-1 rounded-full ${getStatusClass(jobData.status)}`;

        // Re-render required types if the backend updated them
        const typesEl = card.querySelector('.job-required-types');
        if (Array.isArray(jobData.requiredTypes)) {
          typesEl.innerHTML = '';
          jobData.requiredTypes.forEach(t => {
            const span = document.createElement('span');
            span.className = 'bg-gray-700 text-gray-300 text-xs font-medium px-2.5 py-0.5 rounded';
            span.textContent = t;
            typesEl.appendChild(span);
          });
        }

        updateJobPhotos(card, data.photos || jobData.photos || []);
      } catch (err) {
        console.error(`Error fetching job details for ${jobId}:`, err);
      }
    };

    // ---- Modal ----
    createJobBtn.addEventListener('click', () => jobModal.classList.add('is-open'));
    cancelBtn.addEventListener('click', () => jobModal.classList.remove('is-open'));

    // ALWAYS send all 14 required types on submit
    createJobForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const workerPhone = formData.get('workerPhone');
      const sector = parseInt(formData.get('sector'), 10); // <-- new

      const payload = {
        workerPhone,
        requiredTypes: REQUIRED_14,
        sector, // <-- include
      };

      try {
        const res = await fetch(`${API_BASE_URL}/jobs`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text());
        jobModal.classList.remove('is-open');
        e.target.reset();
        fetchAllJobs();
      } catch (err) {
        console.error('Create job error:', err);
        alert('Failed to create job. Check console for details.');
      }
    });

    // ---- Initial load ----
    fetchAllJobs();
  </script>
</body>

</html>